---
import Layout from "../layouts/Layout.astro";
import SearchBar from "../components/SearchBar.astro";
---

<Layout>
  <SearchBar />
	<ul>

  </ul>
</Layout>

<script>
  function rerender(data: any) {
    const ul = document.querySelector(".search-results");
    if(!ul) {
      return
    }

    // Clear all previous search results
    while (ul.firstChild) {
      if(ul.lastChild) {
        ul.removeChild(ul.lastChild);
      }
    }

    // Add new ones
    data.results.forEach((result: any) => {
      const li = document.createElement("li");

      const a = document.createElement("a");
      a.href = result.url
      a.textContent = result.title

      li.appendChild(a);
      ul.appendChild(li);
    });
  }

  function search() {
    const urlSearch = new URLSearchParams(window.location.search);
    const query = urlSearch.get("q");

    if (!query) {
      return;
    }
    const searchBar = document.querySelector(".search-bar") as HTMLFormElement | null;
    const searchInput = document.querySelector(".search-input") as HTMLInputElement | null;
    if (!searchBar || !searchInput) {
      return;
    }
    searchInput.value = query;

    const api = searchBar.getAttribute("data-api");
    if (!api) {
      return;
    }

    fetch(`${api}?${urlSearch.toString()}`).then((result) => {
      result.json().then((data) => {
        rerender(data)
      })
    })
  }

  search()
</script>

<style>

</style>